## 2026-01-01: Clone database to local Docker script

Created script to clone production database to a local Docker container for migration testing. This allows safe testing of migrations before running on production.

Changes:
- scripts/clone-db-to-local.sh: New script that creates/starts Docker PostgreSQL container, dumps prod, restores to local
- package.json: Added db:clone-local script

Usage:
- pnpm db:clone-local
- Clones to localhost:5433 with password "localpassword"

## 2026-01-01: Repo updates only affect latest version

Modified the repo update API to only modify sections/lessons in the latest version. When a repo is updated via /api/repos/update, the system now fetches only the latest version's sections and creates new sections with the correct repoVersionId. Older versions remain untouched.

Changes:
- app/services/db-service.ts: Added getRepoWithSectionsByVersion to fetch repo sections filtered by version
- app/routes/api.repos.update.ts: Get latest version first, filter sections by version, pass repoVersionId to createSections

## 2026-01-01: Backend rejects creating version from non-latest version

Added backend validation to prevent creating new versions from non-latest versions. This ensures data integrity even if the UI fails to hide the option.

Changes:
- app/services/db-service.ts: Added NotLatestVersionError, validation in copyVersionStructure that checks sourceVersionId is latest
- app/routes/api.repos.$repoId.create-version.ts: Handle NotLatestVersionError with 400 response

## 2026-01-01: Create Version visibility based on latest version

Added `isLatestVersion` flag to loader that compares selected version ID with the first (latest) version in the list. The "Create New Version" dropdown option now only shows when viewing the latest version.

Changes:
- app/routes/_index.tsx: Added isLatestVersion calculation in loader, conditional render of Create New Version menu item

## 2026-01-01: Verified all versions remain editable

Confirmed that clip editing works across all versions. Clip update/archive endpoints operate on clip IDs directly with no version restrictions. Each version has its own independent copy of clips (via section → lesson → video → clip hierarchy), so edits in one version don't affect other versions.

No code changes needed - functionality already implemented correctly.

## 2026-01-01: Version selector moved to top bar

Moved version display and selection from sidebar to top bar next to course title. Version now shows in brackets after course name and clicking opens a modal to select versions.

Changes:
- app/components/version-selector-modal.tsx: New modal component listing all versions with checkmark for selected
- app/routes/_index.tsx: Added clickable version badge in h1, added VersionSelectorModal, removed sidebar version dropdown

Tests now passing:
- Version displays in top bar next to course title
- Switching versions updates displayed content
- Version selector modal shows versions ordered by date descending
- Version selector is NOT displayed in sidebar
- URL reflects selected version
- Default to latest version when no versionId in URL
- Versions cannot be deleted (no delete UI/endpoint exists)

## 2026-01-01: Version only visible when multiple versions exist

Added conditional check to only show version badge in top bar when repo has more than one version. Single-version repos no longer show the version indicator, reducing UI clutter.

Changes:
- app/routes/_index.tsx: Added `data.versions.length > 1` check to version badge render condition

## 2026-01-01: Rename Version via Actions dropdown

Implemented "Rename Version" feature accessible from Actions dropdown. Opens modal with current version name pre-filled, saves via API.

Changes:
- app/services/db-service.ts: Added `updateRepoVersionName` method
- app/routes/api.repos.$repoId.rename-version.ts: New API route for version renaming
- app/components/rename-version-modal.tsx: New modal component with form
- app/routes/_index.tsx: Added Rename Version action to dropdown, integrated modal

## 2026-01-01: Rename Course via Actions dropdown

Implemented "Rename Course" feature accessible from Actions dropdown. Opens modal with current repo name pre-filled, saves via API. Name updates in top bar and sidebar after refresh.

Changes:
- app/services/db-service.ts: Added `updateRepoName` method
- app/routes/api.repos.$repoId.rename-repo.ts: New API route for repo renaming
- app/components/rename-repo-modal.tsx: New modal component with form
- app/routes/_index.tsx: Added Rename Course action to dropdown, integrated modal

## 2026-01-01: Delete Version via Actions dropdown

Implemented "Delete Version" feature accessible from Actions dropdown. Only visible when viewing the latest version of a repo with multiple versions. Shows confirmation dialog, then deletes version and all associated data (sections, lessons, videos, clips) via cascade. After deletion, UI refreshes to show the previous version.

Backend validation:
- Cannot delete non-latest version (returns error)
- Cannot delete the only version of a repo (returns error)

Changes:
- app/services/db-service.ts: Added `CannotDeleteOnlyVersionError`, `CannotDeleteNonLatestVersionError` error types and `deleteRepoVersion` method
- app/routes/api.repos.$repoId.delete-version.ts: New API route for version deletion with validation
- app/components/delete-version-modal.tsx: New confirmation modal component
- app/routes/_index.tsx: Added Delete Version action to dropdown (conditional visibility), integrated modal

## 2026-01-01: Delete Version disabled states with tooltips

Updated Delete Version dropdown item to always be visible when a version is selected, but disabled with tooltips explaining why it can't be used in certain conditions.

Disabled states:
- "Cannot delete only version" - shown when repo has only one version
- "Can only delete latest version" - shown when viewing a non-latest version

Changes:
- app/routes/_index.tsx: Added Tooltip import, refactored Delete Version menu item to show disabled state with tooltip when conditions not met

## 2026-01-01: Clear Video Files via Actions dropdown

Implemented "Clear Video Files" feature accessible from Actions dropdown. Deletes all exported video files for the selected version from the file system, freeing up disk space. Database entries remain intact so videos can be re-exported later.

Features:
- Only deletes video files for the currently selected version
- Video files for other versions remain on file system
- Database entries remain intact (UI still shows video metadata)
- Confirmation dialog warns user before deletion
- Shows delete count in API response

Changes:
- app/services/db-service.ts: Added `getVideoIdsForVersion` method to get all video IDs for a version
- app/routes/api.repos.$repoId.clear-video-files.ts: New API route for clearing video files
- app/components/clear-video-files-modal.tsx: New confirmation modal component
- app/routes/_index.tsx: Added Clear Video Files action to dropdown, integrated modal

## 2026-01-01: Changelog generation during export/publish

Implemented automatic changelog generation when publishing a repo. The changelog includes all version history with change detection between versions.

Features:
- Generates changelog.md in Dropbox folder during publish
- Shows versions in reverse chronological order (newest first)
- First/oldest version shows "Initial version."
- Detects new lessons (no previousVersionLessonId)
- Detects renamed sections (path differs from previousVersionSectionId)
- Detects renamed lessons (path differs from previousVersionLessonId)
- Detects content changes via transcript comparison (combined clip text)
- Sections: ### New Lessons, ### Renamed, ### Content Changes

Changes:
- app/services/changelog-service.ts: New service with generateChangelog function
- app/services/db-service.ts: Added getAllVersionsWithStructure method for fetching all versions with full hierarchy
- app/routes/api.repos.publish.ts: Added changelog generation and writing to Dropbox

Tests now passing:
- Export generates full changelog with all version history
- Changelog shows version sections in reverse chronological order
- Changelog detects new lessons per version
- Changelog detects renamed sections/lessons per version
- Changelog detects content changes via transcript comparison
- Initial version shows as 'Initial version' in changelog

## 2026-01-01: Publish errors displayed via sonner toast

Added toast notifications for publish action feedback. Success and error states now show user-friendly toasts.

Features:
- Error toasts display failure reason from API response
- Success toast confirms publish completed
- Toasts are dismissible

Changes:
- app/components/ui/sonner.tsx: Simplified Toaster to use dark theme directly (removed next-themes dependency)
- app/root.tsx: Added Toaster component to app layout
- app/routes/_index.tsx: Added useEffect to handle publishRepoFetcher response and show toast

## 2026-01-01: Hide Delete Version for repos with only one version

Updated UI to completely hide the "Delete Version" dropdown option when a repo has only one version, rather than showing it as disabled. Backend already correctly rejects delete attempts for the sole version.

Changes:
- app/routes/_index.tsx: Added `data.versions.length > 1` condition to Delete Version menu item visibility

## 2026-01-01: Create new version moves video files from previous version

When creating a new version, exported video files are now automatically moved/renamed from the old version's video IDs to the new version's video IDs. This prevents duplicate files on disk and ensures the new version owns the latest video files.

Features:
- Video files renamed from {oldVideoId}.mp4 to {newVideoId}.mp4
- Previous version's video files no longer present (moved, not copied)
- New version's video records point to moved files
- No duplicate video files on file system

Changes:
- app/services/db-service.ts: copyVersionStructure now returns { version, videoIdMappings } instead of just version
- app/routes/api.repos.$repoId.create-version.ts: After copying structure, iterates through videoIdMappings and renames files in FINISHED_VIDEOS_DIRECTORY

## 2026-01-01: Actions menu organized into subsections

Reorganized the Actions dropdown menu into logical subsections with labels and separators for better UX.

Sections:
- Export/Publish actions at top (no label)
- **Course** section: Rename Course
- **Version** section: Create New Version, Rename Version, Delete Version
- **Storage** section: Clear Video Files

Changes:
- app/routes/_index.tsx: Added DropdownMenuGroup, DropdownMenuLabel, DropdownMenuSeparator imports; reorganized menu items into labeled groups with separators between them

## 2026-01-01: Migrate error handling to Effect.die(data(...)) pattern

Standardized error handling across API routes to use `Effect.die(data(..., { status: xxx }))` instead of `Effect.succeed(new Response(...))`. This pattern properly throws errors with react-router's data helper for consistent HTTP response handling.

Changes:
- app/routes/api.repos.add.ts: Import data from react-router, convert catchTag handlers to use Effect.die(data(...))
- app/routes/api.repos.update.ts: Import data from react-router, convert catchAll to use Effect.die(data(...))
- app/routes/api.repos.$repoId.create-version.ts: Import data from react-router, convert catchTag handlers to use Effect.die(data(...))
- app/routes/api.repos.migrate-to-versions.ts: Import data from react-router, convert catchAll to use Effect.die(data(...))
- app/routes/_index.tsx: Import data from react-router, convert NotFoundError handler to use Effect.die(data(...))

## 2026-01-01: Remove unused next-themes dependency

Removed the next-themes package which was no longer used in the codebase. The Toaster component had previously been simplified to use dark theme directly without next-themes integration.

Changes:
- package.json: Removed next-themes dependency via pnpm remove

## 2026-01-01: Rename publish route to publish-to-dropbox

Renamed the publish API route to make its purpose explicit - it publishes to Dropbox specifically.

Changes:
- app/routes/api.repos.publish.ts → app/routes/api.repos.publish-to-dropbox.ts
- app/routes/_index.tsx: Updated action reference from /api/repos/publish to /api/repos/publish-to-dropbox

## 2026-01-01: Extract db-service errors to separate file

Moved error classes from db-service.ts to a new dedicated file for better code organization and reusability.

Changes:
- app/services/db-service-errors.ts: New file containing NotFoundError, UnknownDBServiceError, NotLatestVersionError, CannotDeleteOnlyVersionError, CannotDeleteNonLatestVersionError
- app/services/db-service.ts: Updated to import errors from new file, removed Data import (no longer needed)

## 2026-01-01: Convert updateRepoVersionName to object-based arguments

Refactored updateRepoVersionName to use object-based arguments for consistency and readability.

Changes:
- app/services/db-service.ts: Changed signature from (versionId, name) to ({versionId, name})
- app/routes/api.repos.$repoId.rename-version.ts: Updated caller to use object syntax

## 2026-01-01: Convert updateRepoName to object-based arguments

Refactored updateRepoName to use object-based arguments for consistency with other db-service methods.

Changes:
- app/services/db-service.ts: Changed signature from (repoId, name) to ({repoId, name})
- app/routes/api.repos.$repoId.rename-repo.ts: Updated caller to use object syntax

## 2026-01-01: Convert getRepoWithSectionsByVersion to object-based arguments

Refactored getRepoWithSectionsByVersion to use object-based arguments for consistency with other db-service methods.

Changes:
- app/services/db-service.ts: Changed signature from (repoId, versionId) to ({repoId, versionId})
- app/routes/api.repos.update.ts: Updated both callers to use object syntax
