## Issue #111: Course Planner prototype (tracer bullet)

**Task completed**: Implemented core localStorage-based course planner with sections and lessons

**Key decisions**:
- Used `fractional-indexing` library for ordering (already installed)
- Created `Plan`, `Section`, `Lesson` types with id, title, order fields
- Lessons have a `notes` field for storing lesson notes
- Plans stored in localStorage under "course-plans" key
- SSR-safe localStorage access with `typeof localStorage !== "undefined"` checks
- Plan detail page allows inline editing of plan title, sections, and lessons
- Lesson detail page has auto-saving notes textarea (500ms debounce)

**Files changed**:
- app/features/course-planner/types.ts - New types for Plan, Section, Lesson
- app/hooks/use-plans.ts - New hook for localStorage CRUD operations
- app/components/create-plan-modal.tsx - Modal for creating new plans
- app/components/app-sidebar.tsx - Added Plans collapsible group with context menu delete
- app/routes/plans.$planId.tsx - Plan detail page with section/lesson management
- app/routes/plans.$planId.lessons.$lessonId.tsx - Lesson detail page with notes textarea

**Blockers**: None

**Remaining work for Issue #111**:
- Drag-and-drop reordering for sections and lessons (requires @dnd-kit integration)

---

## Issue #111: Plan rename via context menu (US3)

**Task completed**: Added right-click rename functionality for plans in sidebar

**Key decisions**:
- Inline editing approach: right-click shows "Rename" option, which replaces the plan button with an input field
- Save on Enter key or blur, cancel on Escape
- Uses same `updatePlan` function from `usePlans` hook (already existed)
- Used `useRef` + `useEffect` to auto-focus and select text when rename mode activates

**Files changed**:
- app/components/app-sidebar.tsx - Added PencilIcon, Input import; state for rename mode; Rename context menu item

**Blockers**: None

---

## Issue #111: Drag-and-drop reordering for sections and lessons (US8, US12, US13)

**Task completed**: Added drag-and-drop functionality for reordering sections and lessons

**Key decisions**:
- Installed `@dnd-kit/core` and `@dnd-kit/sortable` for drag-and-drop
- Used existing `reorderSection` and `reorderLesson` functions from `usePlans` hook
- Created `SortableSection` and `SortableLesson` wrapper components with `useSortable` hook
- Added drag handles (GripVertical icon) - visible on hover for lessons, always visible for sections
- Lessons can be reordered within a section or moved between sections
- DragOverlay shows a preview of the dragged item
- 8px activation distance prevents accidental drags when clicking

**Files changed**:
- package.json - Added @dnd-kit/core, @dnd-kit/sortable dependencies
- app/routes/plans.$planId.tsx - Wrapped sections in DndContext, created SortableSection and SortableLesson components

**Blockers**: None

---

## Issue #112: Fix lesson reordering crash (Zz >= Zz error)

**Task completed**: Fixed crash when reordering lessons with duplicate order keys

**Key decisions**:
- Added defensive check in `reorderLesson` and `reorderSection` for when `beforeOrder === afterOrder`
- When duplicate order keys are detected, generate a new key after the duplicate instead of between them
- This handles data corruption gracefully rather than crashing

**Files changed**:
- app/hooks/use-plans.ts - Added duplicate order key handling in reorderLesson and reorderSection

**Blockers**: None

---

## Issue #115: Remove fractional indexing from plans area

**Task completed**: Replaced fractional indexing with simple integer-based ordering for plans

**Key decisions**:
- Changed `order` field from `string` to `number` in Section and Lesson types
- Removed `fractional-indexing` import from use-plans.ts (library still used elsewhere for videos)
- Reordering now uses array-based splice/insert then reassigns sequential integers (0, 1, 2...)
- Adding new items uses `Math.max(...orders) + 1` instead of generateKeyBetween
- Simpler, bug-free approach since all data is in local state anyway

**Files changed**:
- app/features/course-planner/types.ts - Changed order from string to number
- app/hooks/use-plans.ts - Removed fractional-indexing, rewrote reorder functions
- app/routes/plans.$planId.tsx - Changed sorting from localeCompare to numeric comparison

**Blockers**: None

---

## Issue #114: Show sidebar on plans pages

**Task completed**: Added AppSidebar to plan detail and lesson detail pages

**Key decisions**:
- Made AppSidebar props optional with default empty arrays/null values
- Added optional chaining for setIsAddRepoModalOpen and setIsAddStandaloneVideoModalOpen
- Conditionally render AddRepoModal and AddStandaloneVideoModal only when their setters are provided
- Plans section of sidebar works standalone via usePlans hook (localStorage)

**Files changed**:
- app/components/app-sidebar.tsx - Made all props optional with defaults
- app/routes/plans.$planId.tsx - Added AppSidebar to both normal and "not found" returns
- app/routes/plans.$planId.lessons.$lessonId.tsx - Added AppSidebar to both normal and "not found" returns

**Blockers**: None

---

## Issue #113: Hide add section input behind plus button

**Task completed**: Changed add section UI from always-visible input to button that reveals input on click

**Key decisions**:
- Added `isAddingSectionOpen` state to control visibility
- Default state shows a dashed outline button with "Add Section" text
- Clicking button reveals input with Add/Cancel buttons
- Escape key cancels and hides the input
- Enter key submits (existing behavior)
- Input closes automatically after successful add

**Files changed**:
- app/routes/plans.$planId.tsx - Added isAddingSectionOpen state, updated add section UI with conditional rendering

**Blockers**: None

---

## Issue #116: Fix cross-section lesson drag to specific position

**Task completed**: Improved collision detection to allow dropping lessons at specific positions in other sections

**Key decisions**:
- Created custom collision detection that combines `pointerWithin` and `closestCenter`
- Prioritizes lessons over sections when pointer is inside a lesson element
- Added `data: { type: "section" }` to section sortables to distinguish them from lessons
- When dragging over a lesson in another section, that lesson is detected as the drop target

**Files changed**:
- app/routes/plans.$planId.tsx - Added customCollisionDetection function, marked sections with type data

**Blockers**: None

---

## Issue #117: Focus Add Lesson button after creating lesson/section

**Task completed**: Add Lesson button is now focused after creating a lesson or section for quick keyboard-driven workflows

**Key decisions**:
- Added `focusAddLessonInSection` state to track which section's button should be focused
- Added `shouldFocusAddLesson` and `onAddLessonFocused` props to SortableSection
- Used `useRef` and `useEffect` to focus the button when the flag is set
- Focus is triggered after both lesson creation (same section) and section creation (new section)

**Files changed**:
- app/routes/plans.$planId.tsx - Added focus logic with ref, state, and props threading

**Blockers**: None

---

## Issue #118: Replace lesson notes with inline description

**Task completed**: Replaced separate notes page with inline description editing on lessons

**Key decisions**:
- Renamed `notes` field to `description` in Lesson type
- Deleted lesson detail page (`plans.$planId.lessons.$lessonId.tsx`)
- Added inline description display/editing to SortableLesson component
- Description shows under lesson title (or "Add description" link if empty)
- Click on description or "Add description" opens textarea editor inline
- Supports Escape to cancel, Save/Cancel buttons

**Files changed**:
- app/features/course-planner/types.ts - Renamed notes to description
- app/hooks/use-plans.ts - Updated notes references to description
- app/routes/plans.$planId.tsx - Added inline description editing to lessons, removed Link to lesson detail
- Deleted: app/routes/plans.$planId.lessons.$lessonId.tsx

**Blockers**: None

---

## Issue #119: Hide edit buttons on hover, show grip handles always

**Task completed**: Adjusted visibility of edit/delete buttons and grip handles

**Key decisions**:
- Section edit/delete buttons: now hidden by default, visible on section hover (using group/section)
- Plan title edit button: now hidden by default, visible on hover (using group/title)
- Lesson grip handles: now always visible (removed opacity-0 group-hover:opacity-100)
- Lesson edit/delete buttons: remain hidden until hover (unchanged)

**Files changed**:
- app/routes/plans.$planId.tsx - Updated CSS classes for hover visibility

**Blockers**: None

---

## Issue #120: Rename repos to courses in sidebar

**Task completed**: Changed "Repos" to "Courses" in sidebar display

**Key decisions**:
- Simple text replacement in sidebar component
- Does not change any URLs or internal naming (as per requirements)

**Files changed**:
- app/components/app-sidebar.tsx - Changed "Repos" to "Courses", "Archived Repos" to "Archived Courses"

**Blockers**: None

---

## Issue #121: Add section numbers

**Task completed**: Added section numbers (1., 2., 3., etc.) next to section titles

**Key decisions**:
- Added `sectionNumber` prop to SortableSectionProps interface
- Pass `index + 1` when mapping over sortedSections
- Display number before title as muted-foreground text with "." suffix
- Numbers automatically update when sections are reordered

**Files changed**:
- app/routes/plans.$planId.tsx - Added sectionNumber prop and display

**Blockers**: None

---

## Issue #122: Ctrl+Space saves description

**Task completed**: Added Ctrl+Space keyboard shortcut to save description while editing

**Key decisions**:
- Added check for `e.key === " " && e.ctrlKey` in description textarea onKeyDown
- Prevents default behavior to avoid inserting space
- Consistent with escape-to-cancel pattern already in place

**Files changed**:
- app/routes/plans.$planId.tsx - Added Ctrl+Space handling in description Textarea

**Blockers**: None

---

## Issue #123: Add lesson numbers (1.1, 1.2, etc.)

**Task completed**: Added lesson numbers showing section.lesson format

**Key decisions**:
- Added `lessonNumber` prop to SortableLessonProps (string type for "1.1" format)
- Pass `${sectionNumber}.${lessonIndex + 1}` when mapping lessons
- Display number before lesson title in muted-foreground style
- Numbers update automatically when lessons are reordered or moved between sections

**Files changed**:
- app/routes/plans.$planId.tsx - Added lessonNumber prop and display

**Blockers**: None

---

## Issue #124: Add lesson icon selector

**Task completed**: Added clickable icon to lessons for choosing between watch (passive) and code (interactive) lesson types

**Key decisions**:
- Added `LessonIcon` type ("watch" | "code") and optional `icon` field to Lesson type
- Monitor icon = passive exercise (sit back and watch), Code icon = interactive (hands-on coding)
- Default is "watch" (Monitor icon) when no icon is set
- Click icon to toggle between the two options
- Icon appears between grip handle and lesson number
- Hover shows tooltip explaining the current state and that it's clickable

**Files changed**:
- app/features/course-planner/types.ts - Added LessonIcon type and icon field to Lesson
- app/hooks/use-plans.ts - Updated updateLesson to allow icon updates
- app/routes/plans.$planId.tsx - Added icon selector UI with Monitor and Code icons from lucide-react

**Blockers**: None

---

## Issue #125: Reduce Add Lesson button to plus icon only

**Task completed**: Changed Add Lesson button from text + icon to icon-only

**Key decisions**:
- Changed button from `size="sm"` to `size="icon"` with `h-6 w-6` dimensions
- Removed "Add Lesson" text, kept only the Plus icon
- Cleaner, less cluttered UI while maintaining functionality

**Files changed**:
- app/routes/plans.$planId.tsx - Simplified Add Lesson button to icon-only

**Blockers**: None

---

## Issue #126: Reposition lesson icon and make it brighter

**Task completed**: Moved lesson icon after the number and changed color to foreground

**Key decisions**:
- Reordered elements: grip → number → icon → title (was: grip → icon → number → title)
- Changed icon color from `text-muted-foreground` to `text-foreground` for better visibility
- Separated number into its own span element for cleaner layout

**Files changed**:
- app/routes/plans.$planId.tsx - Reordered lesson elements and updated icon color

**Blockers**: None

---

## Issue #127: Move lesson icon to separate column

**Task completed**: Refactored lesson layout to two-column design with prominent icon on left

**Key decisions**:
- Changed SortableLesson from single-row layout to two-column layout using flex with gap-3
- Left column: Large clickable icon (w-6 h-6, up from w-4 h-4) aligned to top of content
- Right column: Title row (grip, number, title, edit buttons) and description below
- Icon spans both title and description visually, creating a more prominent presence
- Removed `ml-6` indentation from description since it now aligns naturally under title
- Added `self-start mt-0.5` to icon button for proper vertical alignment with title text

**Files changed**:
- app/routes/plans.$planId.tsx - Restructured SortableLesson component layout

**Blockers**: None

---

## Issue #128: Create icon prototype page with multiple treatments

**Task completed**: Created prototype page at /icon-prototype with four different icon treatments

**Key decisions**:
- Variant 1 (Current): Large 24px icon in separate left column - prominent and visual
- Variant 2 (Inline Small): Small 16px icon inline between number and title - subtle and compact
- Variant 3 (Colored Badge): Icon with colored background (blue for code, purple for watch)
- Variant 4 (Labeled Pill): Small pill with icon + text label after title - explicit but verbose
- Page includes both a grid comparison and full section preview for each variant
- Used mock data with 4 lessons showing both icon types and with/without descriptions

**Files changed**:
- app/routes/icon-prototype.tsx - New prototype page with 4 icon treatment variants

**Blockers**: None

---

## Issue #128: Implement Circle Badge icon design and remove prototype

**Task completed**: Applied Circle Badge design to plan page and deleted prototype

**Key decisions**:
- Chose Circle Badge variant (Variant 12 from expanded prototype with 12 options)
- Layout: grip handle → circle badge icon → number + title
- Icon in 28px colored circle: yellow (`bg-yellow-500/20 text-yellow-600`) for code, purple (`bg-purple-500/20 text-purple-600`) for watch
- Uses Code and Play icons
- Deleted prototype page after design was finalized

**Files changed**:
- app/routes/plans.$planId.tsx - Updated SortableLesson to Circle Badge layout
- app/routes/icon-prototype.tsx - Deleted

**Blockers**: None

---

## Issue #130: Add third icon (green discussion/conversation)

**Task completed**: Added a third lesson icon type for discussions, colored green

**Key decisions**:
- Extended `LessonIcon` type to include "discussion" alongside "watch" and "code"
- Used `MessageCircle` icon from lucide-react for the discussion type
- Green color scheme: `bg-green-500/20 text-green-600` (consistent with existing yellow/purple pattern)
- Icon click cycles through: watch → code → discussion → watch
- Tooltip shows "Discussion (click to change)" for the new icon type

**Files changed**:
- app/features/course-planner/types.ts - Added "discussion" to LessonIcon type
- app/routes/plans.$planId.tsx - Added MessageCircle import, updated icon rendering and cycle logic

**Blockers**: None

---

## Issue #129: Add ability to duplicate a plan with context menu

**Task completed**: Added actions dropdown menu to plan title with Edit Title and Duplicate Plan options

**Key decisions**:
- Replaced pencil icon next to plan title with a MoreVertical icon triggering a dropdown menu
- Dropdown menu contains "Edit Title" (existing functionality, now in menu) and "Duplicate Plan" (new)
- Added `duplicatePlan` function to `usePlans` hook that deep copies plan with all sections and lessons
- Duplicated plan gets title suffixed with "(Copy)" and new IDs for all sections/lessons
- After duplication, user is navigated to the new plan

**Files changed**:
- app/hooks/use-plans.ts - Added duplicatePlan function
- app/routes/plans.$planId.tsx - Replaced pencil Button with DropdownMenu, added duplicate functionality

**Blockers**: None

---

## Issue #131: Pre-load plan in clientLoader

**Task completed**: Added clientLoader to plan page to prevent "not found" flash

**Key decisions**:
- Added `clientLoader` export that reads plans from localStorage before component renders
- Component uses `loaderData.plan` from clientLoader as initial value
- Falls back to `getPlan` from hook for subsequent updates (after mutations)
- Removed `useParams` usage since planId comes from loaderData

**Files changed**:
- app/routes/plans.$planId.tsx - Added clientLoader, updated component to use loaderData

**Blockers**: None

---

## Issue #132: Add JSON file backup for plans

**Task completed**: Plans are now backed up to a JSON file whenever localStorage is updated

**Key decisions**:
- Created `/api/plans/backup` endpoint that writes plans to `plans-backup.json` in repo root
- Used Effect and @effect/platform FileSystem for file operations (consistent with other API routes)
- Backup is fire-and-forget (non-blocking) - localStorage remains primary store
- Backup file is git-ignored so it stays local but can be manually restored if needed
- JSON is formatted with 2-space indentation for readability

**Files changed**:
- app/routes/api.plans.backup.ts - New API endpoint for JSON backup
- app/hooks/use-plans.ts - Added fetch call to backup API in useEffect
- .gitignore - Added plans-backup.json

**Blockers**: None

---

## Issue #133: Limit description width to 65 characters

**Task completed**: Added max-width constraint to lesson descriptions

**Key decisions**:
- Added `max-w-[65ch]` class to the description div in SortableLesson component
- 65ch is approximately 65 characters wide, improving readability for long descriptions

**Files changed**:
- app/routes/plans.$planId.tsx - Added max-w-[65ch] to description display

**Blockers**: None

---

## Issue #134: Click-to-edit for titles

**Task completed**: Clicking on titles now enters edit mode for plan, section, and lesson titles

**Key decisions**:
- Plan title: h1 element is now clickable with hover effect (`hover:text-muted-foreground`)
- Section title: h2 element is now clickable with hover effect, removed pencil icon
- Lesson title: title div is now clickable with hover effect, removed pencil icon
- Removed "Edit Title" from plan dropdown menu (clicking title handles this now)
- Kept dropdown menu for "Duplicate Plan" functionality
- Removed PencilIcon import as it's no longer used

**Files changed**:
- app/routes/plans.$planId.tsx - Made titles clickable, removed pencil icons

**Blockers**: None

---

## Issue #135: Estimated video count at top of plan

**Task completed**: Added estimated video count to plan header stats

**Key decisions**:
- Video count calculated based on lesson icons: play/watch=1, code=2, discussion=1
- Displayed with ~ prefix to indicate estimate (e.g., "~12 videos")
- Added alongside existing "X sections" and "Y lessons" stats

**Files changed**:
- app/routes/plans.$planId.tsx - Added estimatedVideos calculation and display

**Blockers**: None

---

## Issue #137: Dependency prototype page

**Task completed**: Created prototype page at /dependency-prototype with 5 different UI treatments for lesson dependencies

**Key decisions**:
- Created extended `LessonWithDeps` interface adding `dependencies: string[]` field
- 5 UI variants implemented:
  1. Badge Pills - Dependencies as small removable badges under title
  2. Inline Dropdown - Compact dropdown on right with checkbox selection
  3. Visual Lines - Vertical lines connecting dependent lessons
  4. Expandable Row - Click to expand and see/edit dependencies
  5. Warning Banner - Violations shown as prominent banner at top
- Order violation detection: warns when a lesson depends on another that comes later
- Side-by-side comparison of valid order vs violation state for each variant
- Mock data with 6 lessons across 2 sections demonstrating dependencies

**Files changed**:
- app/routes/dependency-prototype.tsx - New prototype page with 5 dependency UI variants

**Blockers**: None

---

## Issue #136: Auto-capitalize lesson and section titles

**Task completed**: Titles are now automatically capitalized when saved

**Key decisions**:
- Created `capitalizeTitle` helper function that capitalizes the first letter of each word
- Applied to all title save operations: addSection, updateSection, addLesson, updateLesson
- Users can type in lowercase and titles will be capitalized on save

**Files changed**:
- app/routes/plans.$planId.tsx - Added capitalizeTitle function and applied to all title handlers

**Blockers**: None

---

## Issue #138: Fix lesson icon not changing on first click

**Task completed**: Fixed bug where clicking icon on newly created lesson didn't change the icon

**Key decisions**:
- Root cause: New lessons are created without an `icon` field (it's optional)
- When `lesson.icon` is `undefined`, the display correctly shows the Play (watch) icon as default
- But the click handler's cycle logic `lesson.icon === "watch" ? "code" : ...` didn't match `undefined`
- So clicking cycled from `undefined` to `"watch"` - visually no change since both render as Play icon
- Fix: Added `|| lesson.icon === undefined` to treat undefined same as "watch" in the cycle logic
- Now clicking on a new lesson's icon correctly cycles to "code" (yellow)

**Files changed**:
- app/routes/plans.$planId.tsx - Updated icon click handler to treat undefined as "watch"

**Blockers**: None

---

## Issue #137: Rewrite dependency prototype with full lesson UI

**Task completed**: Rewrote dependency prototype to include all UI elements from the actual plan page

**Key decisions**:
- Created `LessonRow` base component matching actual plan page UI (grip handle, circle badge icon, title, description, delete button)
- Created `LessonRowWithTitleSlot` variant for placing elements inline with title
- All 5 variants now use the base components for consistent UI
- Variant 2 (Inline Dropdown) updated to show dependency badge inline with title (not below)
- Badge shows just link icon when no deps, link icon + lesson numbers when has deps
- Mock data updated to include descriptions on some lessons
- Replaced Variant 4 "Expandable Row" with "Subtle Text" variant

**Files changed**:
- app/routes/dependency-prototype.tsx - Complete rewrite with full lesson UI

**Blockers**: None

**Next step**: Issue #139 created to implement Variant 2 and delete prototype

---

## Issue #139: Implement lesson dependencies with inline dropdown UI

**Task completed**: Added dependencies field to lessons with inline dropdown UI for editing

**Key decisions**:
- Added optional `dependencies: string[]` field to Lesson type (array of lesson IDs)
- Updated `updateLesson` in usePlans hook to accept dependencies updates
- Updated `deleteLesson` to clean up deleted lessons from other lessons' dependencies
- Created `FlattenedLesson` interface for dependency dropdown (id, number, title, sectionId)
- Created `checkDependencyViolation` helper to detect when a lesson depends on one that comes later
- Inline dropdown badge shows: muted link icon (no deps), blue with lesson numbers (has deps), amber with warning (violation)
- Dependencies can span sections (e.g., 2.1 can depend on 1.3)
- Deleted prototype page after implementation

**Files changed**:
- app/features/course-planner/types.ts - Added dependencies field to Lesson
- app/hooks/use-plans.ts - Updated updateLesson and deleteLesson for dependencies
- app/routes/plans.$planId.tsx - Added inline dropdown UI and violation detection
- app/routes/dependency-prototype.tsx - Deleted

**Blockers**: None

---

## Issue #140: Remove blue color from dependencies

**Task completed**: Dependencies badge is now gray by default, only orange on error

**Key decisions**:
- Removed the blue styling (`bg-blue-500/20 text-blue-600`) for dependencies without violations
- Dependencies now use gray text (`text-muted-foreground hover:text-foreground`) unless there's a violation
- Violations still show amber/orange styling (`bg-amber-500/20 text-amber-600`)

**Files changed**:
- app/routes/plans.$planId.tsx - Simplified dependency badge styling conditional

**Blockers**: None

---

## Issue #141: Migrate Plans from localStorage to Postgres (tracer bullet)

**Task completed**: Added Drizzle schema tables and sync endpoint for plans

**Key decisions**:
- Created `plan`, `plan_section`, `plan_lesson` tables with cascade deletes
- Used doublePrecision for order field (matching PRD spec for integer ordering)
- Created `getPlans` method in DBService that returns plans in frontend format
- Created `syncPlans` method using delete-all + insert-all pattern (last write wins)
- Created POST `/api/plans/sync` endpoint with Effect Schema validation
- This is the tracer bullet - schema and sync endpoint are ready, hook integration pending

**Files changed**:
- app/db/schema.ts - Added plans, planSections, planLessons tables with relations
- app/services/db-service.ts - Added getPlans and syncPlans methods
- app/routes/api.plans.sync.ts - New sync endpoint

**Blockers**: None

**Remaining work for Issue #141**:
- Add debounced sync (750ms) to usePlans hook
- Load plans via root layout loader (for sidebar availability)
- Create migration endpoint to move localStorage → Postgres
- Add error banner for sync failures
- Run db:push when database is available

---

## Issue #141: Update usePlans hook to sync to Postgres

**Task completed**: Changed backup endpoint to sync endpoint in usePlans hook

**Key decisions**:
- Changed fetch URL from `/api/plans/backup` to `/api/plans/sync`
- Request body format `{ plans }` is identical between both endpoints
- Kept localStorage as primary store (sync is fire-and-forget for now)
- Added TODO comment for future error banner work

**Files changed**:
- app/hooks/use-plans.ts - Updated endpoint URL from backup to sync

**Blockers**: None

---

## Issue #141: Load plans from Postgres via server loaders

**Task completed**: Plans now load from Postgres via server loaders and are passed to AppSidebar/usePlans

**Key decisions**:
- Created GET `/api/plans` endpoint using DBService.getPlans()
- Updated `usePlans` hook to accept `initialPlans` option from server loader
- Added debounced sync (750ms) to avoid overwhelming DB with rapid changes
- Skip initial sync on mount to prevent syncing server data back to server
- Updated `_index.tsx` loader to fetch plans and pass to AppSidebar
- Converted `plans.$planId.tsx` from clientLoader to server loader
- Both pages now pass `initialPlans` prop to AppSidebar

**Files changed**:
- app/routes/api.plans.ts - New GET endpoint for loading plans
- app/hooks/use-plans.ts - Added UsePlansOptions, initialPlans param, debounced sync
- app/components/app-sidebar.tsx - Added initialPlans prop, pass to usePlans
- app/routes/_index.tsx - Loader fetches plans, passes to AppSidebar
- app/routes/plans.$planId.tsx - Converted to server loader, passes plans to usePlans and AppSidebar

**Blockers**: None

**Remaining work for Issue #141**:
- Add error banner for sync failures
- Run db:push when database is available

---

## Issue #141: Add localStorage to Postgres migration endpoint

**Task completed**: Created migration endpoint and automatic migration trigger

**Key decisions**:
- Created POST `/api/plans/migrate` endpoint that only migrates if DB is empty
- Added one-time migration effect in usePlans hook triggered on mount
- Uses `course-plans-migration-attempted` localStorage flag to prevent repeated attempts
- On successful migration, removes `course-plans` from localStorage
- On network error, doesn't mark as attempted so it can retry on next load
- Migration is fire-and-forget (non-blocking for UI)

**Files changed**:
- app/routes/api.plans.migrate.ts - New migration endpoint
- app/hooks/use-plans.ts - Added migration effect and MIGRATION_ATTEMPTED_KEY constant

**Blockers**: None

---

## Issue #141: Add sync error banner for plans

**Task completed**: Added error state tracking and error banner UI for sync failures

**Key decisions**:
- Added `syncError` state (string | null) to usePlans hook to track sync failures
- Added `retrySync` callback function for manual retry from error banner
- Updated fetch call to check response.ok and extract error messages
- Successful sync clears any existing error state
- Error banner shows at top of plan page with destructive styling
- Banner includes error message and Retry button with refresh icon

**Files changed**:
- app/hooks/use-plans.ts - Added syncError state, syncPlans function, retrySync callback
- app/routes/plans.$planId.tsx - Added error banner UI with retry functionality

**Blockers**: None

**Remaining work for Issue #141**:
- Run db:push when database is available

---

## Issue #142: Sync only the active plan instead of all plans

**Task completed**: Changed sync endpoint to only synchronize a single plan at a time

**Key decisions**:
- Added `syncPlan` method to DBService that deletes and re-inserts a single plan by ID
- Changed `/api/plans/sync` endpoint from accepting `{ plans: Plan[] }` to `{ plan: Plan }`
- Added `activePlanId` option to `usePlans` hook to specify which plan to sync
- Updated debounced sync effect to only sync when `activePlanId` is provided and only sync that plan
- Plan detail page now passes `activePlanId: loaderData.plan?.id` to the hook
- Sidebar usage (no activePlanId) no longer triggers syncs on plan list changes

**Files changed**:
- app/services/db-service.ts - Added syncPlan method for single plan sync
- app/routes/api.plans.sync.ts - Changed schema from plans array to single plan
- app/hooks/use-plans.ts - Added activePlanId option, updated sync logic
- app/routes/plans.$planId.tsx - Pass activePlanId to usePlans hook

**Blockers**: None

---

## Issue #143: Remove localStorage migration code

**Task completed**: Removed the localStorage to Postgres migration endpoint and related code

**Key decisions**:
- Migration is no longer needed since plans are now stored in Postgres
- Removed STORAGE_KEY and MIGRATION_ATTEMPTED_KEY constants from usePlans hook
- Removed localStorage fallback in usePlans useState initializer
- Removed the one-time migration useEffect from usePlans hook
- Removed syncPlans (bulk sync) method from DBService since it was only used by migrate endpoint

**Files deleted**:
- app/routes/api.plans.migrate.ts - The migration endpoint

**Files changed**:
- app/hooks/use-plans.ts - Removed localStorage fallback, migration code, and related constants
- app/services/db-service.ts - Removed syncPlans method

**Blockers**: None

---

## Issue #144: Fix plan creation from sidebar (tracer bullet)

**Task completed**: Converted plan creation from local state to server action with redirect

**Key decisions**:
- Created POST `/api/plans` action endpoint that creates plan in Postgres and redirects to plan page
- Updated CreatePlanModal to use `useFetcher` with form submission instead of callback
- Changed AppSidebar from using `usePlans` hook to receiving `plans` prop from server loader
- Added `/api/plans/$planId/delete` and `/api/plans/$planId/rename` endpoints for sidebar operations
- Added `deletePlan` and `renamePlan` methods to DBService
- All sidebar plan operations now use fetchers posting to server actions

**Files created**:
- app/routes/api.plans.$planId.delete.ts - Endpoint for deleting plans
- app/routes/api.plans.$planId.rename.ts - Endpoint for renaming plans

**Files changed**:
- app/routes/api.plans.ts - Added action for plan creation with redirect
- app/components/create-plan-modal.tsx - Converted to useFetcher form
- app/components/app-sidebar.tsx - Removed usePlans hook, uses plans prop, fetchers for mutations
- app/services/db-service.ts - Added deletePlan and renamePlan methods
- app/routes/_index.tsx - Changed initialPlans to plans prop
- app/routes/plans.$planId.tsx - Changed initialPlans to plans prop
- app/routes/archived-repos.tsx - Added plans to loader and sidebar

**Blockers**: None

---

## Issue #147: Redirect home after deleting a plan

**Task completed**: User is now redirected home when deleting a plan they're currently viewing

**Key decisions**:
- Track the plan being deleted with `deletingPlanId` state
- After fetcher returns to idle state, check if current URL matches the deleted plan
- If on the deleted plan's page, navigate to "/"
- Clear `deletingPlanId` after handling to prevent stale redirects

**Files changed**:
- app/components/app-sidebar.tsx - Added useLocation, deletingPlanId state, redirect effect

**Blockers**: None

---

## Issue #149: Plan Page State Refactor - Tracer Bullet (RFC)

**Task completed**: Created plan-state-reducer with all 33 behaviors and comprehensive tests

**Key decisions**:
- Used `useEffectReducer` pattern matching clip-state-reducer (namespace for types + separate const for reducer)
- State shape includes: plan, syncError, editingTitle, editingSection, addingSection, editingLesson, addingLesson, editingDescription, focusRequest
- Two effect types: `plan-changed` (triggers sync) and `focus-element` (triggers UI focus)
- Renamed `createInitialState` to `createInitialPlanState` to avoid esbuild namespace conflict
- All 33 behaviors from RFC implemented with tests:
  - Plan title (1-4): click to edit, change, save, cancel
  - Add section (5-8): click, change, save with focus effect, cancel
  - Edit section (9-11): click, save, cancel
  - Delete section (12): remove and emit plan-changed
  - Add lesson (13-16): click, change, save with focus effect, cancel
  - Edit lesson (17-20): click, change, save, cancel
  - Delete lesson (21): remove lesson and clean up dependencies
  - Lesson description (22-25): click, change, save, cancel
  - Lesson icon (26): update and emit
  - Lesson dependencies (27): update and emit
  - Reordering (28-30): section reorder, same-section lesson reorder, cross-section lesson reorder
  - Sync (31-32): store error, retry
  - Focus (33): clear focus request

**Files created**:
- app/features/course-planner/plan-state-reducer.ts - Reducer with State, Action, Effect types
- app/features/course-planner/plan-state-reducer.test.ts - 37 tests covering all behaviors

**Blockers**: None

**Remaining work for Issue #149**:
- Manual testing

---

## Issue #149: Wire plan-state-reducer to component

**Task completed**: Replaced usePlan hook and 13 useState calls with useEffectReducer-based usePlanReducer

**Key decisions**:
- Created `usePlanReducer` hook that wraps `useEffectReducer` with effect handlers for sync and focus
- Effect handler for `plan-changed` debounces sync to Postgres (750ms), dispatches `sync-failed` on error
- Effect handler for `focus-element` uses `requestAnimationFrame` + `document.querySelector` to focus add-lesson buttons
- Added `data-add-lesson-button` attribute to buttons for focus targeting
- Moved `capitalizeTitle` helper into the reducer (applied to section and lesson titles only, not plan titles)
- `duplicatePlan` remains separate as it's an async operation with navigation
- Drag/drop state (`activeId`, `activeDragType`) remains as separate useState - managed by dnd-kit
- Simplified `SortableSectionProps` from 30+ props down to 5: section, sectionNumber, state, dispatch, allLessons
- Simplified `SortableLessonProps` from 18+ props down to 7: lesson, lessonNumber, sectionId, editingLesson, editingDescription, dispatch, allLessons

**Files created**:
- app/hooks/use-plan-reducer.ts - New hook wrapping useEffectReducer with effect handlers

**Files changed**:
- app/features/course-planner/plan-state-reducer.ts - Added capitalizeTitle helper for section/lesson titles
- app/routes/plans.$planId.tsx - Complete refactor to use reducer dispatch instead of callbacks

**Blockers**: None

---

## Issue #145: Make AppSidebar data props required

**Task completed**: Changed repos, standaloneVideos, and plans props from optional to required

**Key decisions**:
- Made `repos`, `standaloneVideos`, and `plans` required props in AppSidebarProps interface
- Removed default values for these props in function signature
- Updated `plans.$planId.tsx` loader to fetch repos and standaloneVideos (was only fetching plans)
- Updated both AppSidebar usages in `plans.$planId.tsx` to pass all required props
- Modal state props remain optional since not all pages need the add repo/video modals

**Files changed**:
- app/components/app-sidebar.tsx - Made data props required, reordered props in interface
- app/routes/plans.$planId.tsx - Loader now fetches repos and standaloneVideos, passes to AppSidebar

**Blockers**: None


---

## Issue #150: Fix stale data when navigating between plans

**Task completed**: Added key prop to force component recreation when plan ID changes

**Key decisions**:
- Split `PlanDetailPage` into a wrapper and `PlanDetailPageContent` component
- Wrapper passes `key={props.loaderData.plan?.id}` to the content component
- When navigating between plans, the key change forces React to unmount and remount the entire tree
- This reinitializes the reducer with the new plan's data instead of keeping stale state
- Simple, idiomatic React solution that does not require modifying the reducer itself

**Files changed**:
- app/routes/plans.$planId.tsx - Split component and added key prop

**Blockers**: None

---

## Issue #152: Add status marker to plan lessons

**Task completed**: Added TODO/DONE status pill to lessons with toggle functionality

**Key decisions**:
- Added `status` text field to `planLessons` table with default "todo"
- Added `LessonStatus` type ("todo" | "done") and optional `status` field to Lesson interface
- Added `lesson-status-toggled` action to reducer that toggles between todo and done
- Status pill shows gray "TODO" or white "DONE" with check icon
- Pill is clickable to toggle status
- Positioned between the circle badge icon and lesson title
- Status syncs via existing `/api/plans/sync` endpoint

**Files changed**:
- app/db/schema.ts - Added status text field to planLessons table
- app/features/course-planner/types.ts - Added LessonStatus type and status field
- app/features/course-planner/plan-state-reducer.ts - Added lesson-status-toggled action
- app/features/course-planner/plan-state-reducer.test.ts - Added 3 tests for status toggle
- app/routes/plans.$planId.tsx - Added status pill UI to SortableLesson
- app/services/db-service.ts - Updated getPlans and syncPlan to handle status

**Blockers**: None

---

## Issue #151: Redirect home after deleting a plan

**Task completed**: Fixed redirect after deleting a plan by moving logic to server-side action

**Key decisions**:
- Moved redirect logic from client-side useEffect to server-side action handler
- Delete endpoint now checks referer header to determine if user is on the deleted plan's page
- Uses React Router's `redirect()` to navigate home when deleting the current plan
- Removed client-side redirect logic and associated state (`deletingPlanId`, `useLocation`) from AppSidebar
- Server-side redirect is more reliable than client-side state management during React Router revalidation

**Files changed**:
- app/routes/api.plans.$planId.delete.ts - Added referer check and redirect
- app/components/app-sidebar.tsx - Removed client-side redirect logic

**Blockers**: None

---

## Issue #153: Show confirmation modal before deleting sections with lessons

**Task completed**: Added confirmation dialog when deleting sections that contain lessons

**Key decisions**:
- Added `deletingSection` state to reducer: `{ sectionId: string; lessonCount: number } | null`
- Replaced `section-delete-requested` action with three new actions:
  - `section-delete-clicked`: If section is empty, deletes immediately; if has lessons, shows modal
  - `section-delete-confirmed`: Deletes the section and closes modal
  - `section-delete-cancelled`: Closes modal without deleting
- Empty sections still delete immediately without confirmation (better UX)
- Modal shows lesson count and warning about permanent deletion
- Used existing Dialog component from shadcn/ui

**Files changed**:
- app/features/course-planner/plan-state-reducer.ts - Added deletingSection state, replaced delete action with three-step flow
- app/features/course-planner/plan-state-reducer.test.ts - Updated and added tests for new behavior (5 test cases)
- app/routes/plans.$planId.tsx - Changed action type, added Dialog imports and confirmation modal UI

**Blockers**: None

---

## Issue #154: Add confirmation modal before deleting lessons

**Task completed**: Added confirmation dialog when deleting any lesson

**Key decisions**:
- Added `deletingLesson` state to reducer: `{ sectionId: string; lessonId: string } | null`
- Replaced `lesson-delete-requested` action with three new actions:
  - `lesson-delete-clicked`: Shows confirmation modal
  - `lesson-delete-confirmed`: Deletes the lesson and closes modal
  - `lesson-delete-cancelled`: Closes modal without deleting
- All lessons show confirmation (unlike sections which only confirm when not empty)
- Modal shows simple "This action cannot be undone" message
- Used existing Dialog component from shadcn/ui

**Files changed**:
- app/features/course-planner/plan-state-reducer.ts - Added deletingLesson state, replaced delete action with three-step flow
- app/features/course-planner/plan-state-reducer.test.ts - Updated and added tests for new behavior (4 test cases)
- app/routes/plans.$planId.tsx - Changed action type, added confirmation modal UI

**Blockers**: None

---

## Issue #155: Add copy as Markdown from plan page

**Task completed**: Added "Copy as Markdown" option to plan actions dropdown menu

**Key decisions**:
- Added `planToMarkdown` helper function that generates markdown from plan data
- Format: `# Title`, `## N. Section`, `### N.M Lesson Title (Type)` with descriptions
- Lesson type labels: "Explainer" for watch/play, "Interactive" for code, "Discussion" for discussion
- Uses `navigator.clipboard.writeText` for clipboard access
- Added `ClipboardCopy` icon from lucide-react for the menu item
- Placed "Copy as Markdown" as first item in dropdown, above "Duplicate Plan"

**Files changed**:
- app/routes/plans.$planId.tsx - Added planToMarkdown function, ClipboardCopy icon, and new dropdown menu item

**Blockers**: None

---

## Issue #156: Fix add video button in sidebar

**Task completed**: Fixed the add video button not working on pages that don't pass modal state props

**Key decisions**:
- Added internal state `isInternalAddVideoModalOpen` within AppSidebar as fallback
- When `setIsAddStandaloneVideoModalOpen` prop is provided (e.g., on _index.tsx), uses the external state
- When not provided (e.g., on plans.$planId.tsx), uses the internal state
- This matches the pattern already used for the Plans section (`isCreatePlanModalOpen`)
- No changes needed to any route files - the sidebar now works independently

**Files changed**:
- app/components/app-sidebar.tsx - Added internal state and conditional logic for video modal

**Blockers**: None

---

## Issue #160: Add clear chat button to article write page

**Task completed**: Added a clear chat button to the toolbar on the right article page

**Key decisions**:
- Added `Trash2Icon` from lucide-react for the clear button
- Destructured `setMessages` from `useChat` hook to enable clearing messages
- Button appears only when there are messages in the chat (conditional render)
- Button is disabled while streaming to prevent clearing during active generation
- Positioned after the settings button in the toolbar area
- Uses ghost variant with icon-only style, matching the settings button pattern
- Tooltip shows "Clear chat" on hover

**Files changed**:
- app/routes/videos.$videoId.write.tsx - Added Trash2Icon import, setMessages from useChat, and clear button UI

**Blockers**: None

---

## Issue #159: Only show spotted disallowed words in lint feedback

**Task completed**: Changed lint feedback to only include the words that were actually detected in the output

**Key decisions**:
- Replaced `createBannedPhrasesRule()` (single combined rule) with `createBannedPhraseRules()` (array of individual rules)
- Each phrase now has its own LintRule with its own fixInstruction
- Only rules that match the text are included in violations
- Fix message now shows specific phrases found (e.g., `Remove or rephrase: "game changer"`) instead of listing all possible phrases
- No changes needed to use-lint.ts - the hook already correctly handles multiple rules

**Files changed**:
- app/features/article-writer/lint-rules.ts - Replaced createBannedPhrasesRule with createBannedPhraseRules

**Blockers**: None

---

## Issue #157: Add right-click to go to write article page

**Task completed**: Added "Write Article" option to context menu on standalone videos page

**Key decisions**:
- Added `FileTextIcon` import from lucide-react (consistent with write page)
- Added "Write Article" as first context menu item (before Archive/Delete)
- Used `asChild` pattern with `Link` component for navigation
- Applied to both regular and archived videos context menus
- Links to `/videos/${video.id}/write` route

**Files changed**:
- app/routes/videos._index.tsx - Added FileTextIcon import and "Write Article" context menu items

**Blockers**: None

---

## Issue #158: Add ability to rename standalone videos (tracer bullet)

**Task completed**: Added rename functionality to standalone videos page via right-click context menu

**Key decisions**:
- Added `updateVideoPath` method to DBService that updates the `path` field in videos table
- Created `/api/videos/$videoId/rename` endpoint following existing rename-repo pattern
- Created `RenameVideoModal` component following existing RenameRepoModal pattern
- Added "Rename" option to context menus for both active and archived videos
- Uses `PencilIcon` for consistency with other rename actions in the app

**Files created**:
- app/routes/api.videos.$videoId.rename.ts - API endpoint for renaming videos
- app/components/rename-video-modal.tsx - Modal dialog for rename input

**Files changed**:
- app/services/db-service.ts - Added updateVideoPath method
- app/routes/videos._index.tsx - Added rename modal state, imports, and context menu items

**Blockers**: None

---

## Issue #158: Add rename to video editor page and sidebar (completion)

**Task completed**: Added rename functionality to video editor ActionsDropdown and sidebar video list

**Key decisions**:
- Added "Rename Video" option to ActionsDropdown with `PencilLineIcon` (different from Write Article's `PencilIcon`)
- Used existing `RenameVideoModal` component, integrated via context state in VideoEditor
- Added `isRenameVideoModalOpen` and `setIsRenameVideoModalOpen` to VideoEditorContext
- For sidebar, added `videoToRename` state and integrated RenameVideoModal
- Rename menu item appears between "Write Article" and "Copy Transcript" in ActionsDropdown
- Sidebar rename appears before Archive in the context menu

**Files changed**:
- app/features/video-editor/components/actions-dropdown.tsx - Added PencilLineIcon import, onRenameVideoClick prop, and Rename Video menu item
- app/features/video-editor/video-editor-context.tsx - Added isRenameVideoModalOpen and setIsRenameVideoModalOpen to context type
- app/features/video-editor/video-editor.tsx - Added RenameVideoModal import, state, and modal component; passed state through context
- app/features/video-editor/components/video-player-panel.tsx - Added context selector for setIsRenameVideoModalOpen, passed to ActionsDropdown
- app/components/app-sidebar.tsx - Added RenameVideoModal import, videoToRename state, Rename context menu item, and modal component

**Blockers**: None

**Issue #158 complete**: Rename is now available on standalone videos page, video editor page, and sidebar video list

---

## Issue #161: Reveal video in file system (tracer bullet)

**Task completed**: Added "Reveal in File System" context menu option to standalone videos page

**Key decisions**:
- Created `/api/videos/$videoId/reveal` endpoint that runs PowerShell command from WSL
- Uses `wslpath -w` to convert WSL paths to Windows paths
- Uses `powershell.exe -c "explorer.exe '/select,\"path\"'"` to open Explorer with file selected
- Added `FolderOpen` icon from lucide-react for the menu item
- Applied to both regular and archived videos context menus

**Files created**:
- app/routes/api.videos.$videoId.reveal.ts - API endpoint for revealing video in Explorer

**Files changed**:
- app/routes/videos._index.tsx - Added FolderOpen import, revealVideoFetcher, and context menu items

**Blockers**: None

**Remaining work for Issue #161**:
- Add to lesson videos in course editor (if applicable)

---

## Issue #161: Reveal in File System - sidebar video context menu

**Task completed**: Added "Reveal in File System" option to sidebar video context menu

**Key decisions**:
- Added `FolderOpen` icon import from lucide-react
- Added `revealVideoFetcher` alongside existing fetchers
- Menu item placed after "Rename" and before "Archive"
- Uses same API endpoint pattern (`/api/videos/${video.id}/reveal`)

**Files changed**:
- app/components/app-sidebar.tsx - Added FolderOpen icon, revealVideoFetcher, and context menu item

**Blockers**: None

---

## Issue #161: Reveal in File System - video editor ActionsDropdown

**Task completed**: Added "Reveal in File System" option to video editor Actions dropdown menu

**Key decisions**:
- Added `FolderOpen` icon import from lucide-react
- Added `onRevealInFileSystem` callback prop to ActionsDropdown component
- Menu item placed after "Rename Video" option
- Uses same API endpoint pattern as standalone videos page (`/api/videos/${videoId}/reveal`)
- Uses `useFetcher` hook in video-player-panel.tsx for the POST request

**Files changed**:
- app/features/video-editor/components/actions-dropdown.tsx - Added FolderOpen icon, onRevealInFileSystem prop, and menu item
- app/features/video-editor/components/video-player-panel.tsx - Added useFetcher import and revealVideoFetcher, passed callback to ActionsDropdown

**Blockers**: None
