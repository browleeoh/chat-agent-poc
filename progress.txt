# Progress Log

## 2026-01-02

Implemented PRD item #8: Focus refresh uses shared hook with main page

- Created `app/hooks/use-focus-revalidate.ts` - reusable hook for focus-based revalidation
- Hook uses `useRevalidator` from react-router, supports optional interval polling
- Refactored `_index.tsx` to use the new hook instead of inline fetcher logic
- Simplified main page: removed manual poller fetcher, now uses `useFocusRevalidate({ enabled: !!selectedRepoId, intervalMs: 5000 })`

Next: Changelog preview page needs to be created and should use this same hook for focus revalidation.

---

Implemented PRD items #1 & #2: Preview Changelog action visibility

- Added "Preview Changelog" action to Version section in Actions dropdown (`_index.tsx`)
- Action only shows when `versions.length > 1` (hidden for single-version repos)
- Links to `/repos/${repoId}/changelog` route (page not yet created)
- Added FileText icon import from lucide-react

Next: Create changelog preview page route at `app/routes/repos.$repoId.changelog.tsx`

---

Implemented PRD items #3-7: Changelog preview page

- Created `app/routes/repos.$repoId.changelog.tsx` - changelog preview page route
- Page fetches repo and version structure via `DBService.getAllVersionsWithStructure`
- Generates changelog markdown via existing `generateChangelog` from `changelog-service.ts`
- Renders markdown as HTML using `react-markdown` (prose styling via Tailwind)
- Back navigation button returns to main page with repo selected
- Uses `useFocusRevalidate` hook for auto-refresh on focus

PRD is now complete - all 8 items passing.

---

Fixed PRD item #5: Changelog renders as formatted HTML not raw markdown

- Added `@plugin "@tailwindcss/typography"` to `app/app.css` (Tailwind v4 syntax)
- Package was already installed but plugin wasn't imported
- Changelog page already had `prose prose-invert` classes applied

PRD complete - all items verified passing.

---

Implemented PRD items #9-12: Rewrite Repo Path feature

- Added `updateRepoFilePath` method to `DBService` in `app/services/db-service.ts`
- Created API route `app/routes/api.repos.$repoId.rewrite-path.ts` for path updates
- API validates path exists on filesystem before updating, returns error if invalid
- Created `app/components/rewrite-repo-path-modal.tsx` - dialog with pre-filled current path
- Added "Rewrite Repo Path" action to Course section in Actions dropdown (`_index.tsx`)
- Uses FolderPen icon from lucide-react
- Typecheck passes

Next: PRD item #13 (duplicate path validation) still pending.

---

Implemented PRD item #13: Repo update fails if multiple repos share same path

- Added `AmbiguousRepoUpdateError` to `app/services/db-service-errors.ts`
- Modified `updateRepoFilePath` in `db-service.ts` to check for duplicate paths before update
- If multiple repos have same filePath, throws error before any modification
- Updated API route to handle error and return user-friendly message
- Typecheck passes

PRD complete - all 13 items passing.

---

Implemented PRD item #5: Changelog shows deleted items

- Extended `VersionChanges` type with `deletedSections` and `deletedLessons` arrays
- Added detection logic in `detectChanges`: builds sets of referenced section/lesson IDs from current version, then finds previous version items not referenced
- Deleted sections show with "(entire section)" suffix
- Deleted lessons within retained sections show section/lesson path
- Added "Deleted" section rendering in `generateChangelog` output
- Updated `hasChanges` check to include deleted items
- Typecheck passes

PRD complete - all 14 items passing.

---

Fixed PRD item #4: Changelog content matches Dropbox changelog format

- Removed date from version headers in `generateChangelog` (`changelog-service.ts`)
- Version headers now show only version name (e.g., "## v2") instead of "## v2 (2026-01-02)"
- PRD requirement was "version headers without dates"
- Typecheck passes

PRD complete - all 14 items passing.

---

Fixed PRD item #4: Changelog organized by section hierarchy

- Refactored `generateChangelog` in `changelog-service.ts`
- Added `organizeChangesBySection` helper to group changes by section
- Changelog now shows: Version (h2) > Section (h3) > New Lessons/Renamed/Deleted (h4)
- Deleted sections shown separately at top as "Deleted Sections"
- Section renames shown as italic note under section heading
- Preserves section order from current version
- Typecheck passes

---

Fixed PRD item #5: Deleted lessons shown under renamed sections

- Bug: deleted lessons from renamed sections weren't displayed
- Deleted lessons stored old section path, but sections indexed by new path
- Added `oldToNewSectionPath` map to translate old paths to new paths
- Deleted lessons now correctly appear under renamed section headings
- Typecheck passes

---

Implemented PRD item #6: Changelog items use code font with numbered format

- Added `formatCodePath` helper - wraps paths in backticks for code font
- Section/lesson paths now display as `01.03-choosing-your-model` format
- Section headings remain human-readable (no code font)
- Section rename notes and deleted sections use code font
- Typecheck passes

PRD complete - all 15 items passing.

---

Implemented PRD item #12 (standalone-videos): Database schema allows null lessonId

- Made `lessonId` nullable in videos table schema (`app/db/schema.ts`)
- Fixed type errors in routes/services that assumed lesson always exists:
  - `videos.$videoId.edit.tsx`: Handle optional lesson for explainer folder check
  - `videos.$videoId.export-to-davinci-resolve.ts`: Use video.path for standalone video names
  - `videos.$videoId.write.tsx`: Return 400 error for standalone videos (writing requires lesson context)
  - `db-service.ts`: getNextVideoId/getPreviousVideoId return null for standalone videos
  - `text-writing-agent.ts`: Throw error for standalone videos
- Made VideoEditor props optional: lessonPath, repoName, repoId, lessonId
- AddVideoModal returns null when lessonId undefined (standalone videos use different flow)
- Typecheck passes

Next: Need to create standalone videos list page and new video creation flow.

---

Implemented PRD items #1-5: Videos link and list page

- Added "Videos" link to sidebar navigation in `_index.tsx`, alongside "Repos"
- Created `app/routes/videos._index.tsx` - standalone videos list page
- Added `getStandaloneVideos` method to `DBService` - queries videos with null lessonId
- List page shows video path, duration, and export status (VideoIcon vs red VideoOffIcon)
- Clicking video navigates to `/videos/${videoId}/edit`
- Typecheck passes

Next: Add "New Video" button and creation flow for standalone videos.

---

Implemented PRD items #6-8: New Video button and creation flow

- Added `createStandaloneVideo` method to `DBService` - creates video with null lessonId
- Created `app/routes/api.videos.create.ts` - API route for standalone video creation
- Created `app/components/add-standalone-video-modal.tsx` - dialog with name input
- Added "New Video" button to videos list page header
- Button opens dialog, form submits to API, redirects to video editor
- Typecheck passes

Next: Remaining PRD items #9-11 (editor/export verification, delete functionality).

---

Implemented PRD item #11: Can delete standalone video

- Added context menu to videos list page (`videos._index.tsx`)
- Right-click on standalone video shows context menu with "Delete" option
- Delete option uses existing `api.videos.delete.ts` endpoint
- Uses `useFetcher` for optimistic delete flow, page revalidates automatically
- Typecheck passes

Next: PRD items #9-10 are verification items (editor/export work same as lesson videos).

---

Fixed PRD items #9-10: Standalone video editor/export functionality

- Fixed video-editor.tsx to properly handle standalone videos (null lessonId)
- Go Back button now navigates to `/videos` for standalone videos (instead of malformed `/?repoId=undefined#undefined`)
- Repo name / lesson path subtitle hidden when not available
- "Add New Video" action hidden for standalone videos (not applicable)
- Editor and export flow already worked; UI just needed adjustments for missing lesson context
- Typecheck passes

PRD complete - all 12 items passing.

---

Fixed failing tests in clip-state-reducer.test.ts

- Updated test expectations to use `frontendClipId` instead of `clipId` for insertion point assertions
- Added `beatType: "none"` to `update-clips` effect assertions
- Tests now match actual reducer implementation
- All 22 tests pass, typecheck passes

---

Implemented PRD items #14-15: Sidebar restructured with three main items

- Refactored sidebar in `_index.tsx` to use collapsible sections
- Three main items: Repos (collapsible), Videos (collapsible), Diagram Playground (link)
- Repos section: ChevronRight rotates on expand, shows repo list, has plus button to add repo
- Videos section: expands to show "View All Videos" link to /videos
- Diagram Playground: direct link (not collapsible)
- Added Collapsible/ChevronRight/LayoutTemplate imports
- Removed unused ScrollArea import
- Typecheck passes, all tests pass

Next: PRD item #16 (Videos sidebar with add button) partially done - needs video list and add button like Repos.

---

Implemented PRD item #16: Videos sidebar item expands to show video list with add button

- Added `getStandaloneVideos` call to main page loader in `_index.tsx`
- Videos sidebar section now has plus button to open AddStandaloneVideoModal
- Collapsible content shows list of standalone videos with links to video editor
- "View All Videos" link moved to bottom of list
- Pattern matches Repos section structure
- Typecheck passes, all tests pass

Next: PRD items #17-19 remaining (home page recent videos, repo selection, delete confirmation).

---

Implemented PRD item #19: Delete video shows confirmation dialog

- Created `app/components/delete-video-modal.tsx` - confirmation dialog for video deletion
- Pattern matches existing DeleteVersionModal: shows video path, cancel/delete buttons, loading state
- Updated `app/routes/videos._index.tsx` to use confirmation modal instead of direct delete
- Context menu "Delete" now opens modal, modal submits to `/api/videos/delete` on confirm
- Typecheck passes, all tests pass

Next: PRD items #17-18 remaining (home page recent videos, repo selection).

---

Implemented PRD item #17: Home page shows most recent three unattached videos

- Added "Recent Unattached Videos" section to home page (`_index.tsx`)
- Shows when no repo is selected and standalone videos exist
- Displays maximum 3 videos using `.slice(0, 3)` on already-sorted data
- Each video card shows path and duration, links to video editor
- Uses existing `standaloneVideos` data already loaded in loader
- Typecheck passes, all tests pass

Next: PRD item #18 remaining (home page repo selection).

---

Verified PRD item #18: Home page allows selecting a repository

- Feature already implemented in `_index.tsx` lines 903-918
- Home page shows grid of repo cards when no repo selected
- Each card is a `<Link to={\`?repoId=${repo.id}\`}>` navigating to select repo
- Clicking repo updates URL params, triggers loader, shows repo details
- Marked PRD item #18 as passes: true
- Typecheck passes, all tests pass

PRD complete - all 21 items passing.

---

Implemented PRD item #21: Prerecording checklist shows 75% volume indicator with dots

- Created `app/features/video-editor/use-volume-level.ts` - hook for real-time audio volume monitoring
- Uses Web Audio API AnalyserNode to get frequency data, normalizes to 0-1 range
- Created `app/features/video-editor/volume-indicator.tsx` - 8-dot indicator component
- 6 leftmost dots represent 75% target (green when filled), 2 rightmost are overflow (red when filled)
- Unfilled target dots show gray-600, overflow dots show gray-700
- Updated microphone checklist item text to "Turn the microphone to 75%"
- Added VolumeIndicator below the text, fed by liveMediaStream
- Typecheck passes, all tests pass

PRD complete - all 22 items passing.

---

Implemented PRD item #22: Press B while clip is selected to add a beat/pause

- Added `beat-toggle-key-pressed` action to videoStateReducer
- Added `toggle-beat-for-clip` effect type to dispatch when B pressed
- Added effect handler in video-editor.tsx to call `onToggleBeatForClip`
- Added 'B' key handler in keyboard event listener, dispatches through reducer
- Uses `selectedClipsSet` to find currently selected clip (via arrow keys)
- Follows existing pattern: keydown → dispatch action → reducer execs effect → effect handler calls prop
- Typecheck passes, all tests pass

Next: PRD item #23 (beat adds 0.4s to clip duration during playback) still pending.
