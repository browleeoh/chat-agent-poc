# Progress Log

## 2026-01-02

Implemented PRD item #8: Focus refresh uses shared hook with main page

- Created `app/hooks/use-focus-revalidate.ts` - reusable hook for focus-based revalidation
- Hook uses `useRevalidator` from react-router, supports optional interval polling
- Refactored `_index.tsx` to use the new hook instead of inline fetcher logic
- Simplified main page: removed manual poller fetcher, now uses `useFocusRevalidate({ enabled: !!selectedRepoId, intervalMs: 5000 })`

Next: Changelog preview page needs to be created and should use this same hook for focus revalidation.

---

Implemented PRD items #1 & #2: Preview Changelog action visibility

- Added "Preview Changelog" action to Version section in Actions dropdown (`_index.tsx`)
- Action only shows when `versions.length > 1` (hidden for single-version repos)
- Links to `/repos/${repoId}/changelog` route (page not yet created)
- Added FileText icon import from lucide-react

Next: Create changelog preview page route at `app/routes/repos.$repoId.changelog.tsx`

---

Implemented PRD items #3-7: Changelog preview page

- Created `app/routes/repos.$repoId.changelog.tsx` - changelog preview page route
- Page fetches repo and version structure via `DBService.getAllVersionsWithStructure`
- Generates changelog markdown via existing `generateChangelog` from `changelog-service.ts`
- Renders markdown as HTML using `react-markdown` (prose styling via Tailwind)
- Back navigation button returns to main page with repo selected
- Uses `useFocusRevalidate` hook for auto-refresh on focus

PRD is now complete - all 8 items passing.

---

Fixed PRD item #5: Changelog renders as formatted HTML not raw markdown

- Added `@plugin "@tailwindcss/typography"` to `app/app.css` (Tailwind v4 syntax)
- Package was already installed but plugin wasn't imported
- Changelog page already had `prose prose-invert` classes applied

PRD complete - all items verified passing.

---

Implemented PRD items #9-12: Rewrite Repo Path feature

- Added `updateRepoFilePath` method to `DBService` in `app/services/db-service.ts`
- Created API route `app/routes/api.repos.$repoId.rewrite-path.ts` for path updates
- API validates path exists on filesystem before updating, returns error if invalid
- Created `app/components/rewrite-repo-path-modal.tsx` - dialog with pre-filled current path
- Added "Rewrite Repo Path" action to Course section in Actions dropdown (`_index.tsx`)
- Uses FolderPen icon from lucide-react
- Typecheck passes

Next: PRD item #13 (duplicate path validation) still pending.

---

Implemented PRD item #13: Repo update fails if multiple repos share same path

- Added `AmbiguousRepoUpdateError` to `app/services/db-service-errors.ts`
- Modified `updateRepoFilePath` in `db-service.ts` to check for duplicate paths before update
- If multiple repos have same filePath, throws error before any modification
- Updated API route to handle error and return user-friendly message
- Typecheck passes

PRD complete - all 13 items passing.

---

Implemented PRD item #5: Changelog shows deleted items

- Extended `VersionChanges` type with `deletedSections` and `deletedLessons` arrays
- Added detection logic in `detectChanges`: builds sets of referenced section/lesson IDs from current version, then finds previous version items not referenced
- Deleted sections show with "(entire section)" suffix
- Deleted lessons within retained sections show section/lesson path
- Added "Deleted" section rendering in `generateChangelog` output
- Updated `hasChanges` check to include deleted items
- Typecheck passes

PRD complete - all 14 items passing.

---

Fixed PRD item #4: Changelog content matches Dropbox changelog format

- Removed date from version headers in `generateChangelog` (`changelog-service.ts`)
- Version headers now show only version name (e.g., "## v2") instead of "## v2 (2026-01-02)"
- PRD requirement was "version headers without dates"
- Typecheck passes

PRD complete - all 14 items passing.

---

Fixed PRD item #4: Changelog organized by section hierarchy

- Refactored `generateChangelog` in `changelog-service.ts`
- Added `organizeChangesBySection` helper to group changes by section
- Changelog now shows: Version (h2) > Section (h3) > New Lessons/Renamed/Deleted (h4)
- Deleted sections shown separately at top as "Deleted Sections"
- Section renames shown as italic note under section heading
- Preserves section order from current version
- Typecheck passes

---

Fixed PRD item #5: Deleted lessons shown under renamed sections

- Bug: deleted lessons from renamed sections weren't displayed
- Deleted lessons stored old section path, but sections indexed by new path
- Added `oldToNewSectionPath` map to translate old paths to new paths
- Deleted lessons now correctly appear under renamed section headings
- Typecheck passes
