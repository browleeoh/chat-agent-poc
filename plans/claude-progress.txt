# Versioning Feature Progress

## 2026-01-01: Database Schema for Versioning

### Work Done
Added foundational database schema for course versioning:

1. **New `repoVersions` table**
   - id, repoId, name, createdAt
   - Cascade delete from repos
   - Relations to repos and sections

2. **Updated `sections` table**
   - Added optional `repoVersionId` field (for gradual migration)
   - Added `previousVersionSectionId` for changelog tracking
   - Kept `repoId` for backward compatibility during migration

3. **Updated `lessons` table**
   - Added `previousVersionLessonId` for changelog tracking

4. **Added relations**
   - repoVersionsRelations: repo <-> sections
   - Updated reposRelations to include versions
   - Updated sectionsRelations to include repoVersion

### Next Steps
- Implement version selector UI
- Implement "Create New Version" functionality

### PRD Status
All features still marked as `passes: false` - schema is foundation only.
Most important next feature: "Migration creates v1.0 for existing repos"

---

## 2026-01-01: Migration Endpoint and DBService Version Methods

### Work Done
Added migration endpoint and version management methods:

1. **New migration endpoint: POST /api/repos/migrate-to-versions**
   - Gets all repos without versions
   - Creates v1.0 repoVersion for each
   - Updates all sections to point to repoVersionId
   - Returns count of migrated/skipped repos

2. **DBService version methods**
   - `getRepoVersions(repoId)` - list all versions for repo, ordered by date desc
   - `getLatestRepoVersion(repoId)` - get most recent version
   - `getRepoVersionById(versionId)` - get specific version
   - `createRepoVersion({repoId, name})` - create new version

3. **Updated createSections**
   - Now accepts optional `repoVersionId` parameter
   - Sections can be created with version association

### PRD Status
1 of 19 features passing:
- ✅ "Migration creates v1.0 for existing repos"

### Next Steps
- Implement version selector UI in sidebar
- Implement "Create New Version" functionality

---

## 2026-01-01: Cascade Deletion Through Version Hierarchy

### Work Done
Verified and tested cascade deletion works through the version hierarchy:

1. **Added `deleteRepo` method to DBService**
   - Deletes a repo by ID
   - Cascade configured at schema level handles all child entities

2. **Schema cascade configuration verified**
   - `repoVersions`: CASCADE from `repos`
   - `sections`: CASCADE from both `repos` and `repoVersions`
   - `lessons`: CASCADE from `sections`
   - `videos`: CASCADE from `lessons`
   - `clips`: CASCADE from `videos`

3. **Added integration test**
   - `db-service.test.ts` verifies full cascade: repo -> versions -> sections -> lessons -> videos -> clips
   - Test requires DATABASE_URL to be set

### PRD Status
2 of 19 features passing:
- ✅ "Migration creates v1.0 for existing repos"
- ✅ "Cascade deletion works through version hierarchy"

### Next Steps
- Implement version selector UI in sidebar
- Implement "Create New Version" functionality

---

## 2026-01-01: Version Selector UI in Sidebar

### Work Done
Implemented version selector dropdown in sidebar:

1. **Updated loader in `_index.tsx`**
   - Added `versionId` URL search param handling
   - Fetches all versions for selected repo via `getRepoVersions`
   - If versionId provided, uses that version; otherwise defaults to latest
   - Filters sections by `repoVersionId` to show only content for selected version
   - Returns `versions` and `selectedVersion` in loader data

2. **Added version selector UI**
   - Select dropdown appears below repo list when repo is selected
   - Shows all versions with name and creation date
   - Versions ordered newest to oldest (from DBService query)
   - Changing version updates URL with `versionId` param
   - Latest version auto-selected when no versionId in URL

### PRD Status
7 of 19 features passing:
- ✅ "Migration creates v1.0 for existing repos"
- ✅ "Cascade deletion works through version hierarchy"
- ✅ "Version selector displays in sidebar when repo is selected"
- ✅ "Switching versions updates displayed content"
- ✅ "Version selector shows versions ordered by date descending"
- ✅ "URL reflects selected version"
- ✅ "Default to latest version when no versionId in URL"

### Next Steps
- Implement "Create New Version" functionality
- Implement changelog generation

---

## 2026-01-01: Create New Version Copies Structure

### Work Done
Implemented "Create New Version" functionality that copies structure from current version:

1. **DBService.copyVersionStructure method**
   - Creates new version record
   - Copies all sections, lessons, videos from source version
   - Copies only non-archived clips (archived clips excluded)
   - Sets `previousVersionSectionId` on new sections
   - Sets `previousVersionLessonId` on new lessons
   - Enables change tracking for changelog generation

2. **New API endpoint: POST /api/repos/$repoId/create-version**
   - Accepts `name` and `sourceVersionId` form data
   - Validates name is non-empty
   - Returns new version id and name

3. **CreateVersionModal component**
   - Dialog with version name input
   - Required validation (HTML5 + Schema.minLength)
   - Shows "Creating..." during submit
   - Auto-closes on success

4. **Actions dropdown menu item**
   - "Create New Version" option appears when version is selected
   - Opens CreateVersionModal

### PRD Status
10 of 19 features passing:
- ✅ "Migration creates v1.0 for existing repos"
- ✅ "Cascade deletion works through version hierarchy"
- ✅ "Version selector displays in sidebar when repo is selected"
- ✅ "Switching versions updates displayed content"
- ✅ "Version selector shows versions ordered by date descending"
- ✅ "URL reflects selected version"
- ✅ "Default to latest version when no versionId in URL"
- ✅ "Create new version copies structure from current version"
- ✅ "New version tracks references to previous version entities"
- ✅ "Create version modal validates input"

### Next Steps
- Implement "Repo updates only affect latest version"
- Implement changelog generation